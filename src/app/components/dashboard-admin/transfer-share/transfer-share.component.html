<div *ngIf="activeView == 'search'">
    <app-search-edit (statusView)="onTransferStockSelected($event)"></app-search-edit>
</div>

<div *ngIf="activeView === 'transfer'">
    <div class="m-4 rounded-md shadow-md bg-white">
        <p class="text-center py-3 rounded-t-md bg-green-400 text-xl font-semibold text-white">รายการใบหุ้น :
            ออกใบหุ้นใหม่แทนใบหุ้นที่ชำรุด/สูญหาย</p>
        <div class="text-center py-4 gap-4">
            <div class="flex justify-center gap-4">
                <p>บัตรแสดงตนเลขที่ : {{ customerData.cusiD }}</p>
                <p>สถานะ : {{ customerData.staDesc }} </p>
            </div>
            <p>ชื่อ - นามสกุล : {{ customerData.title }}{{ customerData.fname }} {{ customerData.lname }}</p>
        </div>
        <div class="p-4">
            <table class="table-auto w-full border border-gray-300 rounded-lg shadow-sm">
                <thead>
                    <tr class="bg-blue-600 text-white text-sm uppercase tracking-wider">
                        <th class="px-4 py-2 text-center">ลำดับ</th>
                        <th class="px-4 py-2 text-left">สาขา</th>
                        <th class="px-4 py-2 text-left">หมายเลขใบหุ้น</th>
                        <th class="px-4 py-2 text-left">หมายเลขใบหุ้นเดิม</th>
                        <th class="px-4 py-2 text-left">หมายเลขหุ้น</th>
                        <th class="px-4 py-2 text-right">จำนวนหุ้น</th>
                        <th class="px-4 py-2 text-right">มูลค่าหุ้น</th>
                        <th class="px-4 py-2 text-center">สถานะ</th>
                        <th class="px-4 py-2 text-center">วันเวลาที่ทำรายการ</th>
                        <th class="px-4 py-2 text-center">ออกใบหุ้นใหม่</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200" *ngFor="let item of stkTransList; ">
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-2 text-center">{{ item.roWi }}</td>
                        <td class="px-4 py-2">{{ item.brCode }}</td>
                        <td class="px-4 py-2">{{ item.stkNOTE }}</td>
                        <td class="px-4 py-2">{{ item.stkNOTEo }}</td>
                        <td class="px-4 py-2">{{ item.stkNOStart }} - {{ item.stkNOStop }}</td>
                        <td class="px-4 py-2 text-right">{{ item.stkUNiT | number:'1.0-0' }}</td>
                        <td class="px-4 py-2 text-right">{{ item.stkVALUE | number:'1.0-0'}}</td>
                        <td class="px-4 py-2 text-center">{{ item.stDESC }}</td>
                        <td class="px-4 py-2 text-center">{{ formatThaiDateTime(item.datetimeup) || '-' }}</td>
                        <td class="px-4 py-2 text-center">
                            <button class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
                                (click)="onTransferClick(item)">
                                โอนเปลี่ยนมือ
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<div *ngIf="activeView == 'transfers'" class="max-w-7xl mx-auto p-4 bg-white shadow-lg rounded-lg">
    <div class="bg-green-500 text-white text-center py-3 rounded-t-lg mb-4">
        <h2 class="text-xl font-semibold">ใบแจ้งโอนหุ้น</h2>
    </div>
    <div class="bg-gray-50 p-3 mb-4" *ngIf="selectedcustomer">
        <div class="grid grid-cols-3 gap-2">
            <div>เลขบัตรแสดงตน : {{ selectedcustomer.cusId || '-' }}</div>
            <div>หมายเลขใบหุ้น : {{ selectedcustomer.stkNote || '-' }}</div>
            <div>หมายเลขหุ้น : {{ selectedcustomer.stkNoStart || '-' }} - {{ selectedcustomer.stkNoStop || '-' }}
            </div>
        </div>
        <div class="grid grid-cols-3 gap-2 mt-1">
            <div>ชื่อ - นามสกุล : {{ selectedcustomer.titleDesc}}{{ selectedcustomer.cusFName}} {{
                selectedcustomer.cusLName}}</div>
            <div>สถานะ : {{ selectedcustomer.stDesc || '-' }}</div>
            <div>จำนวน : {{ selectedcustomer.stkUnit || 0 }} หุ้น / {{ selectedcustomer.stkValue || 0 }} บาท</div>
        </div>

        <div class="border-t border-gray-300 my-4"></div>

        <div class="flex items-center justify-center my-6 space-x-4 text-base font-medium">
            <div class="flex items-center space-x-2">
                <span class="bg-blue-100 text-black px-3 py-1 rounded">ผู้โอน</span>
                <span class="text-gray-400 text-2xl">⬆️-⬇️</span>
                <span class="bg-blue-100 text-black px-3 py-1 rounded">ผู้รับโอน</span>
            </div>
        </div>

        <div class="flex justify-center">
            <form class="space-y-4 w-full">
                <div class="flex items-center space-x-2">
                    <label for="" class="font-medium text-gray-700 w-40">เหตุผลการโอนหุ้น :</label>
                    <select [(ngModel)]="transferReason" id="reason" name="reason"
                        class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="">เลือกเหตุผล</option>
                        <option *ngFor="let rem of remcodeList" [value]="rem.remCode">
                            {{ rem.remDesc }}
                        </option>
                    </select>
                </div>

                <!-- แสดงข้อมูลผู้รับโอนเมื่อพบ -->
                <form [formGroup]="transferForm" class="p-4 mb-4">
                    <div formArrayName="transfers">
                        <div *ngFor="let t of transfers.controls; let i = index" [formGroupName]="i"
                            class="flex flex-col items-start w-full mt-4 p-4 bg-gray-200 rounded shadow">

                            <!-- Row 1 -->
                            <div class="grid grid-cols-2 gap-2 w-full justify-center">
                                <div class="flex items-center justify-end gap-4">
                                    <span class="text-gray-900 w-40 flex justify-end">
                                        {{i+1}} บัตรแสดงตนเลขที่ :
                                    </span>
                                    <input type="text"
                                        class="text-gray-500 border-2 bg-blue-100 border-blue-700 rounded font-medium focus:outline-none w-60 px-3 py-2"
                                        formControlName="CUSid" disabled>
                                </div>

                                                                 <div class="flex items-center justify-between w-full">
                                     <div class="flex items-center gap-4">
                                         <span class="font-medium text-gray-700 w-40 flex justify-end">จำนวนหุ้น :</span>
                                         <input type="number"
                                             class="text-gray-700 border-2 bg-lime-100 border-lime-400 rounded font-medium focus:outline-none w-60 px-3 py-2"
                                             formControlName="CUSun"
                                             [max]="getRemainingSharesForNextPerson(i)"
                                             [min]="1"
                                             (input)="onShareAmountChange(i)">
                                     </div>
                                     <button type="button" (click)="removeAt(i)" class="cursor-pointer hover:shadow-xl">❌</button>
                                 </div>
                            </div>

                            <!-- Row 2 -->
                            <div class="grid grid-cols-2 gap-4 w-full mt-3">
                                <div class="flex items-center justify-end gap-4">
                                    <span class="text-gray-900 w-40 flex justify-end">ชื่อ - นามสกุล :</span>
                                    <input type="text"
                                        class="text-gray-900 rounded font-medium focus:outline-none w-60 px-3 py-2"
                                        formControlName="Name" readonly>
                                </div>
                            </div>

                            <!-- เงินปันผล -->
                            <div class="grid grid-cols-12 gap-3 w-full mt-3">
                                <div class="font-medium text-gray-900 col-span-1">เงินปันผล :</div>

                                <div class="flex flex-col gap-2 ml-0 col-span-11">
                                    <!-- เงินสด -->
                                    <label class="flex items-center gap-2">
                                        <input type="radio" value="002" formControlName="payTY" />
                                        <span>รับเป็นเงินสด</span>
                                    </label>

                                    <div class="flex">
                                        <!-- บัญชีเงินฝาก -->
                                        <label class="flex items-start gap-2 col-span-2">
                                            <div class="items-center flex gap-2">
                                                <input type="radio" value="001" formControlName="payTY" />
                                                <span>บัญชีเงินฝาก</span>
                                            </div>
                                        </label>

                                        <!-- แสดงรายละเอียดบัญชีเฉพาะเมื่อเลือกบัญชีเงินฝาก -->
                                        <div *ngIf="t.get('payTY')?.value === '001'" class="space-y-3">
                                            <!-- บัญชีเงินฝาก -->
                                            <div class="grid grid-cols-3 gap-4 items-center">
                                                <div class="text-right font-medium col-span-1">บัญชีเงินฝาก :</div>
                                                <div class="col-span-2 flex gap-3 items-center">
                                                    <select formControlName="accTY"
                                                        class="text-gray-700 border-2 border-blue-700 bg-blue-100 rounded font-medium focus:outline-none w-60 px-3 py-2" disabled>
                                                        <option *ngFor="let item of accList" [value]="item.accType">
                                                            {{ item.accDesc }}
                                                        </option>
                                                    </select>
                                                    <span>เลขที่บัญชี :</span>
                                                    <input type="text" formControlName="accNO"
                                                        class="text-gray-700 border-2 border-lime-400 bg-lime-100 rounded font-medium focus:outline-none w-60 px-3 py-2" />
                                                </div>
                                            </div>

                                            <!-- ชื่อบัญชี -->
                                            <div class="grid grid-cols-3 gap-4 items-center">
                                                <div class="text-right font-medium">ชื่อบัญชี :</div>
                                                <div class="col-span-2">
                                                    <input type="text" formControlName="accNA"
                                                        class="text-gray-700 border-2 border-lime-400 bg-lime-100 rounded font-medium focus:outline-none w-60 px-3 py-2" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- บริจาค -->
                                    <label class="flex items-center gap-2">
                                        <input type="radio" value="003" formControlName="payTY" />
                                        <span>บริจาคให้ ธ.ก.ส.</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- แสดงช่องบัตรแสดงตนตลอดเวลา -->
                <form [formGroup]="searchForm" *ngIf="sesstionSearch" (ngSubmit)="searchReceiver()"
                    class="flex items-center space-x-2">
                    <div class="flex items-center space-x-2">
                        <label for="" class="font-medium text-gray-700 w-40">เลขบัตรแสดงตน :</label>
                        <input type="text" formControlName="stkOWNiD" name="idCard"
                            class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <button type="submit"
                            class="bg-green-300 hover:bg-green-400 text-white px-3 py-2 rounded flex items-center justify-center">
                            <span class="text-lg">➕</span>
                        </button>
                    </div>
                                 </form>



                 <div class="flex justify-center space-x-4 mt-6">
                     <!-- ปุ่มบันทึก - แสดงเมื่อมีรายการผู้รับโอนเท่านั้น -->
                     <button type="button" (click)="submitAll()"
                         [disabled]="!checkTransferableShares().canTransfer || checkTransferableShares().totalRequested === 0"
                         [class]="checkTransferableShares().canTransfer && checkTransferableShares().totalRequested > 0
                                 ? 'bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded flex items-center'
                                 : 'bg-gray-400 text-gray-600 px-6 py-2 rounded flex items-center cursor-not-allowed'">
                         บันทึก
                     </button>
                    <button type="button" (click)="cancelAll()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded flex items-center">
                        ยกเลิก
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- หน้า Summary -->
    <div *ngIf="activeView == 'summary'" class="max-w-7xl mx-auto p-4 shadow-lg rounded-lg">
        <div class="bg-green-500 text-white text-center py-3 rounded-t-lg mb-4">
            <h2 class="text-xl font-semibold">โอนเปลี่ยนมือ : รายละเอียด</h2>
        </div>

        <div *ngIf="summaryData" class="space-y-4">
            <!-- ผู้โอน -->
            <div class="bg-blue-100 p-3 mb-4 rounded border border-blue-200">
                <h3 class="text-lg font-semibold text-blue-800 mb-3">ผู้โอน</h3>
                <div class="grid grid-cols-3 gap-2">
                    <div class="text-blue-900">ชื่อ - นามสกุล : {{ summaryData.transferor.name }}</div>
                    <div class="text-blue-900">หมายเลขใบหุ้น : {{ summaryData.transferor.shareCertificate }}</div>
                    <div class="text-blue-900">หมายเลขหุ้น : {{ summaryData.transferor.shareNumbers }}</div>
                </div>
                <div class="grid grid-cols-3 gap-2 mt-1">
                    <div class="text-blue-900">จำนวน : {{ summaryData.transferor.shareCount }} หุ้น / {{ summaryData.transferor.shareValue }} บาท</div>
                    <div class="text-blue-900">รับเงินปันผลโดย : {{ summaryData.transferor.dividendMethod }}</div>
                </div>
            </div>

            <div class="border-t border-blue-300 my-4"></div>

            <!-- ผู้รับโอน -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-blue-800">ผู้รับโอน ({{ summaryData.totalRecipients }} คน)</h3>
                <div *ngFor="let transferee of summaryData.transferees; let i = index" 
                     class="bg-blue-200 p-4 rounded shadow border border-blue-200">
                    <h4 class="font-medium text-blue-700 mb-2">ผู้รับโอนคนที่ {{ i + 1 }}</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="text-blue-900">ชื่อ - นามสกุล : {{ transferee.name }}</div>
                        <div class="text-blue-900">หมายเลขใบหุ้น : {{ transferee.shareCertificate }}</div>
                        <div class="text-blue-900">หมายเลขหุ้น : {{ transferee.shareNumbers }}</div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mt-1">
                        <div class="text-blue-900">จำนวน : {{ transferee.shareCount }} หุ้น / {{ transferee.shareValue }} บาท</div>
                        <div class="text-blue-900">รับเงินปันผลโดย : {{ transferee.dividendMethod }}</div>
                    </div>
                </div>
            </div>

            <!-- ปุ่มกลับ -->
            <div class="flex justify-center space-x-4 mt-6">
                <button type="button" (click)="goBack()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded flex items-center">
                    กลับ
                </button>
            </div>
        </div>
    </div>

 <div *ngIf="loading"
     class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 bg-opacity-40 backdrop-blur-sm"
     style="background-color: rgba(128, 128, 128, 0.7);">
     <div class="text-center">
         <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24">
             <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
             <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" />
         </svg>
         <p class="text-lg text-white font-medium">🔄 กำลังโหลดข้อมูล กรุณารอสักครู่...</p>
     </div>
 </div>