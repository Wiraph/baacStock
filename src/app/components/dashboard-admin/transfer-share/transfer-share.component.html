<div *ngIf="activeView == 'search'">
  <app-search-edit (statusView)="onTransferStockSelected($event)"></app-search-edit>
</div>

<div *ngIf="activeView === 'transfer'">
    <div class="m-4 rounded-md shadow-md bg-white">
        <p class="text-center py-3 rounded-t-md bg-green-400 text-xl font-semibold text-white">รายการใบหุ้น :
            ออกใบหุ้นใหม่แทนใบหุ้นที่ชำรุด/สูญหาย</p>
        <div class="text-center py-4 gap-4">
            <div class="flex justify-center gap-4">
                <p>บัตรแสดงตนเลขที่ :  {{ customerData.cusiD }}</p>
                <p>สถานะ : {{ customerData.staDesc }} </p>
            </div>
            <p>ชื่อ - นามสกุล : {{ customerData.title }}{{ customerData.fname }} {{ customerData.lname }}</p>
        </div>
        <div class="p-4">
            <table class="table-auto w-full border border-gray-300 rounded-lg shadow-sm">
                <thead>
                    <tr class="bg-blue-600 text-white text-sm uppercase tracking-wider">
                        <th class="px-4 py-2 text-center">ลำดับ</th>
                        <th class="px-4 py-2 text-left">สาขา</th>
                        <th class="px-4 py-2 text-left">หมายเลขใบหุ้น</th>
                        <th class="px-4 py-2 text-left">หมายเลขใบหุ้นเดิม</th>
                        <th class="px-4 py-2 text-left">หมายเลขหุ้น</th>
                        <th class="px-4 py-2 text-right">จำนวนหุ้น</th>
                        <th class="px-4 py-2 text-right">มูลค่าหุ้น</th>
                        <th class="px-4 py-2 text-center">สถานะ</th>
                        <th class="px-4 py-2 text-center">วันเวลาที่ทำรายการ</th>
                        <th class="px-4 py-2 text-center">ออกใบหุ้นใหม่</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200" *ngFor="let item of stkTransList; ">
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-2 text-center">{{ item.roWi }}</td>
                        <td class="px-4 py-2">{{ item.brCode }}</td>
                        <td class="px-4 py-2">{{ item.stkNOTE }}</td>
                        <td class="px-4 py-2">{{ item.stkNOTEo }}</td>
                        <td class="px-4 py-2">{{ item.stkNOStart }} - {{ item.stkNOStop }}</td>
                        <td class="px-4 py-2 text-right">{{ item.stkUNiT | number:'1.0-0' }}</td>
                        <td class="px-4 py-2 text-right">{{ item.stkVALUE | number:'1.0-0'}}</td>
                        <td class="px-4 py-2 text-center">{{ item.stDESC }}</td>
                        <td class="px-4 py-2 text-center">{{ formatThaiDateTime(item.datetimeup) || '-' }}</td>
                        <td class="px-4 py-2 text-center">
                            <button class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600" 
                                    (click)="onTransferClick(item)">
                                โอนเปลี่ยนมือ
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<div *ngIf="activeView == 'transfers'" class="max-w-7xl mx-auto p-4 bg-white shadow-lg rounded-lg">
    <div class="bg-green-500 text-white text-center py-3 rounded-t-lg mb-4">
        <h2 class="text-xl font-semibold">ใบแจ้งโอนหุ้น</h2>
    </div>
    <div class="bg-gray-50 p-3 mb-4" *ngIf="selectedcustomer && selectStockTransfer">
        <div class="grid grid-cols-3 gap-2">
        <div>เลขบัตรแสดงตน : {{ selectedcustomer.cusId || '-' }}</div>
        <div>หมายเลขใบหุ้น : {{ selectStockTransfer.stkNote || '-' }}</div>
        <div>หมายเลขหุ้น : {{ selectStockTransfer.stkStart || '-' }} - {{ selectStockTransfer.stkEnd || '-' }}</div>
    </div>
    <div class="grid grid-cols-3 gap-2 mt-1">
        <div>ชื่อ - นามสกุล : {{ selectedcustomer.fullName || '-' }}</div>
        <div>สถานะ : {{ selectedStock.staDesc || '-' }}</div>
        <div>จำนวน : {{ selectStockTransfer.unit || 0 }} หุ้น</div>
    </div>

    <div class="border-t border-gray-300 my-4"></div>

        <div class="flex items-center justify-center my-6 space-x-4 text-base font-medium">
        <div class="flex items-center space-x-2">
            <span class="bg-blue-100 text-black px-3 py-1 rounded">ผู้โอน</span>
            <span class="text-gray-400 text-2xl">⬆️-⬇️</span>
            <span class="bg-blue-100 text-black px-3 py-1 rounded">ผู้รับโอน</span>
        </div>
    </div>

    <div class="border-t border-gray-300 my-4"></div>

        <form class="space-y-4 max-w-2xl mx-auto">
            <div class="flex items-center space-x-2">
                <label class="font-medium text-gray-700 w-40">เหตุผลการโอนหุ้น :</label>
                <select [(ngModel)]="transferForm.reason" 
                name="reason" class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">เลือกเหตุผล</option>
                <option *ngFor="let rem of remcodeList" [value]="rem.remCode">
                    {{ rem.remDesc }}
                </option>
            </select>
            </div>
            <div class="flex items-center space-x-2">
                <label class="font-medium text-gray-700 w-40">เลขบัตรแสดงตน :</label>
                <input type="text" [(ngModel)]="transferForm.idCard" name="idCard" class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <button type="button" 
                        (click)="onAddPerson()"
                        class="bg-green-300 hover:bg-green-400 text-white px-3 py-2 rounded flex items-center justify-center">
                    <span class="text-lg">➕</span>
                </button>
            </div>
            
            <div *ngIf="foundUser" class="border-t border-gray-300 my-4"></div>
            
            <!-- แสดงข้อมูลผู้รับโอนเมื่อพบ -->
            <div *ngIf="foundUser" class="bg-gray-50 p-4 mb-4">
                <div class="flex justify-between items-start w-full">
                    <!-- ข้อมูลซ้าย -->
                    <div class="flex-1 space-y-3">
                        <div class="flex items-center">
                            <span class="font-medium text-gray-700 w-40">บัตรแสดงตนเลขที่ :</span>
                            <span class="text-gray-900 font-medium">{{ transferForm.idCard || '-' }}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="font-medium text-gray-700 w-40">ชื่อ - นามสกุล :</span>
                            <span class="text-gray-900 font-medium">{{ foundUser.fullName || '-' }}</span>
                        </div>
                    </div>
                    
                    <!-- ข้อมูลขวา -->
                    <div class="flex-1 flex justify-end">
                        <div class="flex items-center">
                            <span class="font-medium text-gray-700 mr-3">จำนวนหุ้นที่ต้องการโอน :</span>
                            <div class="flex items-center space-x-2">
                                <input type="number" 
                                       [(ngModel)]="transferForm.shareAmount" 
                                       name="shareAmount" 
                                       min="0" 
                                       [max]="selectStockTransfer?.unit || 0"
                                       [disabled]="isShareAmountConfirmed"
                                       [class]="isShareAmountConfirmed ? 'border border-gray-300 rounded px-3 py-2 text-center w-24 bg-gray-100 cursor-not-allowed' : 'border border-gray-300 rounded px-3 py-2 text-center w-24 focus:outline-none focus:ring-2 focus:ring-blue-500'">
                                <span class="text-gray-700 font-medium">หุ้น</span>
                                
                                <!-- ปุ่มยืนยัน - แสดงเมื่อยังไม่ยืนยัน -->
                                <button *ngIf="!isShareAmountConfirmed" 
                                        type="button" 
                                        (click)="onConfirmShareAmount()"
                                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm font-medium ml-2">
                                    ✔️
                                </button>
                                
                                <!-- ปุ่มแก้ไข - แสดงเมื่อยืนยันแล้ว -->
                                <button *ngIf="isShareAmountConfirmed" 
                                        type="button" 
                                        (click)="onEditShareAmount()"
                                        class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-sm font-medium ml-2">
                                    ✖️
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div *ngIf="foundUser" class="border-t border-gray-300 my-4"></div>

            <!-- รับเงินปันผล - แสดงเฉพาะเมื่อพบผู้รับโอนแล้ว -->
            <div *ngIf="foundUser" class="grid grid-cols-4 gap-6 px-4 mt-2 items-start">
                    <label class="col-span-1 whitespace-nowrap text-gray-700 font-semibold text-right">
                        รับเงินปันผลเป็น :
                    </label>
                    <div class="col-span-3">
                        <div class="flex gap-4 items-start">
                            <!-- Radio -->
                            <input type="radio" name="stkPayType" id="bankAccount" class="mt-2" value="001"
                                [(ngModel)]="transferForm.payType">

                            <!-- Form -->
                            <div class="flex flex-col gap-4 w-full">
                                <!-- Grid 2 columns -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Account Type -->
                                    <div class="flex items-center gap-2">
                                        <label for="accountType"
                                            class="whitespace-nowrap text-gray-700">บัญชีเงินฝาก :</label>
                                        <select id="accountType" name="accountType"
                                             class="border border-gray-300 rounded-md p-2 bg-blue-100 font-semibold w-full cursor-not-allowed pointer-events-none"
                                             [(ngModel)]="transferForm.accountType" [disabled]="true">
                                             <option *ngFor="let act of actypeList" [value]="act.accType">
                                                 {{act.accDesc}}</option>
                                        </select>
                                    </div>
                                    <!-- Account Number -->
                                    <div class="flex items-center gap-2">
                                        <label for="accountNumber"
                                            class="whitespace-nowrap text-gray-700">บัญชีเลขที่
                                            :</label>
                                        <input type="text" id="accountNumber" name="accountNumber"
                                            [(ngModel)]="transferForm.accountNumber"
                                            class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                <!-- Account Name -->
                                <div class="flex items-center gap-2">
                                    <label for="accountName"
                                        class="whitespace-nowrap text-gray-700">ชื่อบัญชี :
                                    </label>
                                    <input type="text" id="accountName" name="accountName"
                                        [(ngModel)]="transferForm.accountName"
                                        class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-2">
                            <input type="radio" name="stkPayType" value="003" [(ngModel)]="transferForm.payType">
                            <label>บริจาคให้ ธ.ก.ส.</label>
                        </div>
                    </div>
                </div>
            
            <div class="flex justify-center space-x-4 mt-6">
                <!-- ปุ่มบันทึก - แสดงเมื่อยืนยันจำนวนหุ้นแล้ว -->
                <button *ngIf="isShareAmountConfirmed && foundUser" 
                        type="button" 
                        (click)="onSaveTransferRecord()"
                        class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded flex items-center">
                    บันทึก
                </button>
                
                <button type="button" 
                        (click)="onCancelTransfer()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded flex items-center">
                    ยกเลิก
                </button>
            </div>
        </form>
</div>

<div *ngIf="loading"
  class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 bg-opacity-40 backdrop-blur-sm"
  style="background-color: rgba(128, 128, 128, 0.7);">
  <div class="text-center">
    <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none"
      viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" />
    </svg>
    <p class="text-lg text-white font-medium">🔄 กำลังโหลดข้อมูล กรุณารอสักครู่...</p>
  </div>
</div>